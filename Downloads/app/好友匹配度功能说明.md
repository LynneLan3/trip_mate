# 好友匹配度功能说明

## 功能概述

在被分享人提交问卷后的结果页面，会显示分享人（好友）的信息和与好友的答案匹配度。

## 功能特点

### 1. 显示好友信息
- **头像**：显示好友的个人头像，如果没有头像则显示昵称首字母
- **昵称**：显示好友的昵称
- **性别和地区**：显示好友的性别和所在省份
- **旅行风格标签**：显示好友的测试结果标签

### 2. 答案匹配度（百分制）
- **计算方式**：相同答案的题目数 ÷ 总题目数 × 100
- **评分规则**：
  - 答案相同：计入匹配
  - 答案不同：不计入匹配
  - 最终以百分比形式显示（0-100%）
- **突出显示**：答案匹配度以大字号、醒目的蓝色卡片展示

### 3. 风格相似度
- **计算方式**：基于测试分数差异计算
- **公式**：100 - |分数差| = 相似度百分比
- **作为辅助参考**：以次要方式展示

## 使用流程

### 场景：用户A分享问卷给用户B

1. **用户A完成问卷**
   - 答题并提交
   - 获得自己的测试结果

2. **用户A分享链接给用户B**
   - 复制带有 `?from=用户A的ID` 的分享链接
   - 通过微信、QQ等方式发送给用户B

3. **用户B通过链接答题**
   - 点击链接，看到"XXX邀请你参与测试"的提示
   - 完成所有题目并提交

4. **用户B查看结果**
   - 在结果页自动显示：
     - 用户B自己的测试结果
     - 用户A的头像和昵称
     - 与用户A的答案匹配度（百分制）
     - 与用户A的风格相似度

5. **用户A查看匹配**
   - 在"我的匹配"页面可以看到用户B的答题情况
   - 双方都可以选择同意/拒绝匹配

## 技术实现

### 前端更新

#### ResultPage.tsx
```typescript
// 1. 获取from参数（分享人ID）
const fromParam = searchParams.get('from') || sessionStorage.getItem(`from_${resultId}`);

// 2. 优先查找与分享人的匹配记录
const { data: specificMatch } = await supabase
  .from('matches')
  .select('*')
  .or(`and(requester_id.eq.${fromParam},receiver_id.eq.${user.id}),and(requester_id.eq.${user.id},receiver_id.eq.${fromParam})`)
  .eq('quiz_id', quizId)
  .maybeSingle();

// 3. 计算答案匹配度
const totalQuestions = Object.keys(myAnswers).length;
const matchingAnswers = Object.keys(myAnswers).filter(
  key => myAnswers[key] === theirAnswers[key]
).length;
const answerMatchPercent = Math.round((matchingAnswers / totalQuestions) * 100);
```

#### QuizPage.tsx
```typescript
// 提交后跳转时携带from参数
const resultPath = fromUserId 
  ? `/result/${resultId}?from=${fromUserId}`
  : `/result/${resultId}`;
navigate(resultPath);
```

### UI组件

- 使用 `Avatar` 组件显示头像
- 使用渐变背景和阴影效果突出显示匹配度
- 响应式设计，适配移动端和桌面端

## 数据库要求

确保以下Supabase配置已完成：

1. **matches表的RLS策略**：允许被分享者插入匹配记录
2. **quiz_results表的RLS策略**：允许查询匹配用户的答题结果
3. **profiles表的RLS策略**：允许查询匹配用户的基本信息

详见 `supabase-quiz-matches-setup.md`

## 界面预览

### 匹配结果卡片结构
```
┌─────────────────────────────────────┐
│ 🏆 与好友的匹配结果                  │
├─────────────────────────────────────┤
│ [头像] 张三                          │
│       👨 男 📍 北京                  │
│       🗺️ 探险家                      │
├─────────────────────────────────────┤
│        答案匹配度                    │
│           75%                        │
│   你们有 75% 的答案相同              │
├─────────────────────────────────────┤
│ 风格相似度           85%            │
│ TA 的得分            82 分          │
├─────────────────────────────────────┤
│ 💡 匹配度说明：答案匹配度根据...    │
└─────────────────────────────────────┘
```

## 注意事项

1. **隐私保护**：只有双方都完成问卷后才能看到匹配信息
2. **缓存机制**：使用sessionStorage缓存from参数，避免刷新页面后丢失
3. **容错处理**：如果没有from参数，会查找任意匹配记录
4. **双向匹配**：创建两条匹配记录，确保双方都能在匹配列表中看到对方

## 后续优化建议

1. 添加答案明细对比（显示具体哪些题目相同/不同）
2. 添加匹配度排行榜（显示与多个好友的匹配情况）
3. 添加匹配度分析图表（雷达图、柱状图等）
4. 添加社交分享功能（分享匹配结果到朋友圈）
