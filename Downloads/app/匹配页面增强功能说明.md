# 匹配页面增强功能说明

## 更新时间
2026年2月12日

## 新增功能

### 1. ✅ 显示问卷名称
在每个匹配卡片中显示该匹配对应的问卷名称，方便用户了解是基于哪个问卷产生的匹配。

**展示位置**：用户头像和信息下方，匹配度上方

**展示样式**：
- 使用 ClipboardList 图标
- 格式："问卷：旅行风格测试"（示例）
- 使用灰色和深色文字搭配

### 2. ✅ 显示匹配度数值
基于两人的答题结果，自动计算匹配度百分比，并以数字和进度条的形式展示。

**计算方式**：
- 比对两人在同一问卷中的所有答案
- 计算相同答案的数量占总题目数的百分比
- 公式：`匹配度 = (相同答案数 / 总题目数) × 100%`

**展示样式**：
- Award 图标 + "匹配度：" + 百分比数字 + 进度条
- 数字显示：大字号、粗体、绿色
- 进度条颜色根据匹配度动态变化：
  - 80% 及以上：绿色（高度匹配）
  - 60-79%：主题绿色（中高度匹配）
  - 40-59%：橙色（中等匹配）
  - 40% 以下：红色（低匹配）

## 功能详情

### 数据结构更新

#### MatchWithDetails 接口
```typescript
interface MatchWithDetails {
  // ... 原有字段
  myResult: {
    tag: string;
    score: number;
    answers: any;  // 新增：用于计算匹配度
  } | null;
  otherResult: {
    tag: string;
    score: number;
    answers: any;  // 新增：用于计算匹配度
  } | null;
  quizTitle: string;      // 新增：问卷名称
  matchScore: number;     // 新增：匹配度百分比
}
```

### 匹配度计算逻辑

```typescript
const calculateMatchScore = (myAnswers: any, otherAnswers: any): number => {
  // 1. 确保 answers 是对象格式
  // 2. 获取所有问题代码
  // 3. 比对每个问题的答案
  // 4. 计算相同答案的比例
  // 5. 返回百分比（0-100）
}
```

### 数据获取优化

在 `fetchMatches` 函数中：
1. 获取问卷信息：`quizzes` 表查询 `title` 字段
2. 获取完整答题结果：`quiz_results` 表查询 `tag, score, answers` 字段
3. 调用 `calculateMatchScore` 计算匹配度
4. 将所有信息合并到返回对象中

## 界面展示

### 卡片布局（从上到下）

```
┌─────────────────────────────────────────┐
│ [头像] 用户昵称                          │
│        性别 · 地区                       │
│        创建时间                          │
├─────────────────────────────────────────┤
│ 📋 问卷：旅行风格测试                    │
├─────────────────────────────────────────┤
│ 🏆 匹配度：85% [████████░░]             │
├─────────────────────────────────────────┤
│ 你: 探险家 | 对方: 自由行者              │
├─────────────────────────────────────────┤
│ [已匹配]                    [查看联系方式]│
└─────────────────────────────────────────┘
```

### 颜色方案

| 匹配度范围 | 颜色 | 含义 |
|-----------|------|------|
| 80-100% | `bg-green-500` | 高度匹配 |
| 60-79% | `bg-[#2D5A27]` | 中高度匹配 |
| 40-59% | `bg-orange-500` | 中等匹配 |
| 0-39% | `bg-red-500` | 低匹配 |

## 技术实现

### 修改的文件

#### src/pages/MatchesPage.tsx

**新增导入**：
```typescript
import { Award } from 'lucide-react';
```

**新增函数**：
- `calculateMatchScore()` - 计算匹配度

**修改部分**：
- `MatchWithDetails` 接口 - 添加新字段
- `fetchMatches()` - 获取问卷信息和完整答题结果
- 卡片渲染逻辑 - 显示问卷名称和匹配度

## 用户体验优化

### 1. 直观的匹配度展示
- 大字号、粗体的百分比数字，一目了然
- 彩色进度条，视觉化展示匹配程度
- 颜色编码，快速识别匹配质量

### 2. 完整的匹配信息
- 问卷名称：明确是哪个问卷的匹配
- 匹配度：量化两人的相似度
- 答题结果：查看具体的标签分类
- 状态标识：了解匹配进展

### 3. 信息层次清晰
- 使用图标区分不同类型的信息
- 灰色辅助文字 + 深色主要内容
- 合理的间距和分组

## 数据流程

```
用户打开匹配页面
    ↓
获取所有匹配记录
    ↓
对每个匹配：
    1. 获取对方用户信息
    2. 获取问卷信息（问卷名称）
    3. 获取双方答题结果（包含 answers）
    4. 计算匹配度
    ↓
展示匹配卡片：
    - 用户信息
    - 问卷名称
    - 匹配度（数字 + 进度条）
    - 答题标签
    - 操作按钮
```

## 示例数据

### 高匹配度（85%）
```
问卷：旅行风格测试
匹配度：85% [████████▓░]  (绿色进度条)
你: 探险家 | 对方: 探险家
```

### 中匹配度（65%）
```
问卷：兴趣爱好测试
匹配度：65% [██████▓░░░]  (主题绿色进度条)
你: 文艺青年 | 对方: 运动达人
```

### 低匹配度（35%）
```
问卷：性格测试
匹配度：35% [███▓░░░░░░]  (红色进度条)
你: 内向型 | 对方: 外向型
```

## 注意事项

1. **答案数据格式**：
   - 系统会自动处理字符串和对象两种格式
   - 如果 answers 是字符串，会自动 JSON.parse

2. **匹配度计算**：
   - 只比较相同问题的答案
   - 如果一方未答题，匹配度为 0
   - 结果向下取整（Math.round）

3. **性能优化**：
   - 使用 Promise.all 并行获取数据
   - 一次性获取所有必要信息

4. **错误处理**：
   - 问卷不存在时显示"未知问卷"
   - 答题结果不存在时显示"未答题"
   - 匹配度计算失败时默认为 0

## 测试清单

- [ ] 显示正确的问卷名称
- [ ] 匹配度计算准确
- [ ] 进度条颜色根据匹配度变化
- [ ] 高匹配度显示绿色进度条
- [ ] 低匹配度显示红色进度条
- [ ] 未答题时显示 0% 匹配度
- [ ] 多个匹配记录都能正确显示
- [ ] 界面布局美观、信息层次清晰

## 后续优化建议

1. **详细的匹配分析**：
   - 点击匹配度可查看详细的题目对比
   - 显示哪些题目相同、哪些不同

2. **匹配度排序**：
   - 支持按匹配度从高到低排序
   - 筛选高匹配度的记录

3. **匹配建议**：
   - 根据匹配度给出互动建议
   - 高匹配度时推荐立即联系

4. **统计信息**：
   - 显示平均匹配度
   - 显示最高匹配度记录

5. **匹配度算法优化**：
   - 考虑题目权重
   - 使用更复杂的相似度算法
